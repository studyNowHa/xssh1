wget https://go.dev/dl/go1.19.2.linux-amd64.tar.gz
sudo tar -C /usr/local -xzf go1.19.2.linux-amd64.tar.gz
echo 'export PATH=$PATH:/usr/local/go/bin' >> $HOME/.profile
echo 'export PATH="$PATH:~/go/bin"' >> $HOME/.profile
source $HOME/.profile
go install github.com/caddyserver/xcaddy/cmd/xcaddy@latest
~/go/bin/xcaddy build --with github.com/caddyserver/forwardproxy@caddy2=github.com/klzgrad/forwardproxy@naive
echo ":443, 2022freedns.tk #你的域名
tls example@example.com #你的邮箱
route {
 forward_proxy {
   basic_auth user pass #用户名和密码
   hide_ip
   hide_via
   probe_resistance
  }
 #支持多用户
 forward_proxy {
   basic_auth user2 pass2 #用户名和密码
   hide_ip
   hide_via
   probe_resistance
  }
 reverse_proxy  https://demo.cloudreve.org  { #伪装网址
   header_up  Host  {upstream_hostport}
   header_up  X-Forwarded-Host  {host}
  }
}" > Caddyfile

安装 Cloudflared
curl -LO https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
sudo dpkg -i cloudflared-linux-amd64.deb
rm cloudflared-linux-amd64.deb

登录 Cloudflared
cloudflared tunnel login

证书
-----BEGIN CERTIFICATE-----
MIIEFTCCAv2gAwIBAgIUbnRnPudxjx61tpQwvxtNTEm2B6QwDQYJKoZIhvcNAQEL
BQAwgagxCzAJBgNVBAYTAlVTMRMwEQYDVQQIEwpDYWxpZm9ybmlhMRYwFAYDVQQH
Ew1TYW4gRnJhbmNpc2NvMRkwFwYDVQQKExBDbG91ZGZsYXJlLCBJbmMuMRswGQYD
VQQLExJ3d3cuY2xvdWRmbGFyZS5jb20xNDAyBgNVBAMTK01hbmFnZWQgQ0EgMTdh
OTY4OWU1Y2M5MTA4NWMxNzJjNzMxOGNjOTlkOTQwHhcNMjIxMTAyMDc0MzAwWhcN
MzcxMDI5MDc0MzAwWjAiMQswCQYDVQQGEwJVUzETMBEGA1UEAxMKQ2xvdWRmbGFy
ZTCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBAOlaazfQ8bWvb+6EBn+X
6qBWA7eYrg73+xc1erfXH5xuhAmW6jMF0o6Ddj04YFGb/o01EQ+x4n9NWLlOKqnL
LtWuMUo89QuwD7A9b2rkSMlL8rwEoWkTHYRVr0PAPtibm6pw4T+YCyuyuHAYCprY
fXkdgas15OtZMOOpRT49cbsoAbht3seVMOiHTqP0ER7A4xS7dTRwBL17AtOX+Cmf
U3p4MS6qqnv28vHf3LtqyojZe6y62yugfmw7hIuyBAngbwil9ZhEWZTBkqG4H/bj
Jr2sHf4SfsEjyCt8g68ngA0A5M+70WKMszGkBpNeULTD6F83UxW5e0B4cef4Ok+U
Ce0CAwEAAaOBuzCBuDATBgNVHSUEDDAKBggrBgEFBQcDAjAMBgNVHRMBAf8EAjAA
MB0GA1UdDgQWBBRy1kkrEVb8VApuwvNNTLtnkfKYTjAfBgNVHSMEGDAWgBQtwweD
lNGkZDqzaqG3+xMsQiCOfTBTBgNVHR8ETDBKMEigRqBEhkJodHRwOi8vY3JsLmNs
b3VkZmxhcmUuY29tLzc3MGNhN2FjLWM3NzItNDMxMy05NzAxLTcxZmRlODdhMzUy
Yy5jcmwwDQYJKoZIhvcNAQELBQADggEBAK+8vJm0e+8mC5CblXE9dzrvxarXpRWy
KvI7NfeGQTBbTTLc/EpooU4F9RHwQmOpS8zkAlBgw120S6uLa3xWs2aVTGMhIYOV
oA1drGFUTLEgLkgqefEL0Ie4D7LGK/c/GtZQTeqepOINhgE/Oev6fLp3KYGNX/UK
52pnxH4jMug7OND8pPbfaMrK3llJuoS3Qj1mAYlHez2ZfeKMQyN3dioxctYfuDom
eXMWi0kkjBNSDEwxk3V/8hrOmFCpf1i7vwuxH3Kgh9GAleqLC/F4uqh8kwtAgOgI
uVPbJAx9Mk67Zz+O8+V2uXz3dzTdLYg3aLFKeKv5kPRC3+xxaPs6AJw=
-----END CERTIFICATE-----


新建隧道
cloudflared tunnel create vps

新建 Tunnel 对应的 DNS 记录
cloudflared tunnel route dns vps 2022freedns.tk

新建配置文件
echo "tunnel: <Tunnel-UUID>
credentials-file: /root/.cloudflared/<Tunnel-UUID>.json
protocol: h2mux
originRequest:
  connectTimeout: 30s
  noTLSVerify: false
ingress:
  - hostname: <SUBDOMAIN>
    service: http://localhost:80
  - service: http_status:404" > ~/.cloudflared/config.yml
  
启动 Cloudflared
修改systemd文件  
sudo echo "[Unit]
Description=cloudflared
After=network.target

[Service]
TimeoutStartSec=0
Type=notify
ExecStart=/usr/bin/cloudflared --loglevel debug --transport-loglevel warn --config /root/.cloudflared/config.yml tunnel run vps
Restart=on-failure
RestartSec=5s

[Install]
WantedBy=multi-user.target" >> /etc/systemd/system/cloudflared.service

启动 Cloudflared
systemctl enable cloudflared --now

